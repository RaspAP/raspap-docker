name: Build Docker Images

on:
  push:
    branches: ['master']
  schedule:
    # Cron execution is for weekly dependencies update (for security update)
    #             ┌───────────── minute (0 - 59)
    #             │ ┌───────────── hour (0 - 23)
    #             │ │ ┌───────────── day of the month (1 - 31)
    #             │ │ │ ┌───────────── month (1 - 12 or JAN-DEC)
    #             │ │ │ │ ┌───────────── day of the week (0 - 6 or SUN-SAT)
    - cron: '0 0 * * 0'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code from Git repository
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Docker login to GitHub
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare available platforms build
        env:
          requested_platforms: 'linux/amd64,linux/arm64,linux/arm/v7'
        run: |
          IFS=',' read -r -a requested_platforms <<< "${requested_platforms}"
          IFS=',' read -r -a available_platforms <<< "${{ steps.buildx.outputs.platforms }}"
          available_platforms=$(comm -12 <(printf '%s\n' "${requested_platforms[@]}" | LC_ALL=C sort) <(printf '%s\n' "${available_platforms[@]}" | LC_ALL=C sort))
          requested_platforms="${requested_platforms//'\n'/,}"
          available_platforms="${available_platforms//'\n'/,}"
          echo "available_platforms=$available_platforms"
          echo "requested_platforms=${requested_platforms}" >> $GITHUB_ENV

      # Use cache image for quicker build time.
      - name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # Build & push Docker images
      - name: Docker build & push - Dockerfile.deb11
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          dockerfile: Dockerfiles/Dockerfile.deb11
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new
          platforms: ${{ env.available_platforms }}
          tags: ${{ github.repository }}:bullseye

      - name: Docker build & push - Dockerfile.deb12
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          dockerfile: Dockerfiles/Dockerfile.deb12
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new
          platforms: ${{ env.available_platforms }}
          tags: ${{ github.repository }}:bookworm

      # Save new cache
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
